<!DOCTYPE html>
<html>
<head>
<link rel="stylesheet" type='text/css' href="../css/edfbase.css"></style>
<link rel="stylesheet" type='text/css' href="../css/edfdataviewer.css"></style>
<!-- Load scripts locally -->
<script src="../js/plotly-latest.min.js"></script>
<script src="../js/edf.js"></script>
<!-- Load scripts from CDNs -->
<script type="text/javascript">
  if (typeof EDF == 'undefined') {
    document.write(unescape("%3Cscript src='https://cdn.rawgit.com/jusjusjus/edfjs/master/js/edf.js' type='text/javascript'%3E%3C/script%3E"));
  }
  if (typeof Plotly == 'undefined') {
    document.write(unescape("%3Cscript src='https://cdn.plot.ly/plotly&#45;latest.min.js' type='text/javascript'%3E%3C/script%3E"));
  }
</script>
<script>
	var edf = EDF();
	var selected = null;
	var window_duration = 10.0; // seconds

	var load_selected_file = async function () {
		var files = document.getElementById('fileSelector').files;
    selected = EDF();
    selected.from_file(files[0], files_loaded, header_only=false);
	}

	function select_file (f=null) {
		refresh_navbar();
		create_new_plot();
	}

	var clear_filecache = function () {
		selected = null;
		refresh_navbar();
    clear_drawing_area();
	}

	function refresh_navbar() {
    var nav = document.getElementById("nav");
    var txt = "";
    if (selected != null) {
      for (var c in selected.channels) {
        var C = selected.channels[c];
        txt += "<li";
        if (C.selected) {
          txt += " class='selected'";
        } else {
          txt += " class='unselected'";
        }
        txt += " onclick='switch_selection("+c+")'>"+C.label+"</li>";
      }
      txt += "<li class='clear' onclick='clear_filecache()'>Clear</li>";
    }
    nav.innerHTML = txt;
	}

	function clear_drawing_area() {
		areaFrame = document.getElementById("areaFrame");
		areaFrame.innerHTML = '';
	}

	function create_drawing_area() {
		areaFrame = document.getElementById("areaFrame");
    var selected_channels = get_selected_channels(selected);
		var txt = "<div class='drawingArea' id='drawingArea' style='height:"+100*selected_channels.length+"px;width:100%;'></div>";
		txt += "<form class='sliderFrame' oninput='secondDisplay.value=new Date(selected.startdatetime.getTime()+1000*(+currTime.value)).toISOString()'>";
		txt += "<input class='timeSlider' type='range' id='currTime' name='currTime' min='0' max='"+selected.duration+"' value='0' oninput='set_time(this.value)'>";
		txt += "<output name='secondDisplay' for='currTime'></output></form>";
		areaFrame.innerHTML = txt;
	}

  function get_selected_channels(channels) {
    var selected_channels = [];
    for (c in selected.channels) {
      C = selected.channels[c];
      if (C.selected) {
        selected_channels.push(C);
      }
    }
    return selected_channels;
  }

  function switch_selection(c) {
    selected.channels[c].selected = !(selected.channels[c].selected);
    refresh_navbar();
    create_new_plot();
  }

	function create_new_plot() {
		create_drawing_area();
		var t0=0.0;
		var traces = [];
		var layout = {
			xaxis: {title: "relative time (sec.)"},
			margin: { t: 0, b: 20, l: 40, r: 20 }
		};
    selected_channels = get_selected_channels(selected.channels);
		var domain = Array.from(new Array(selected_channels.length+1), (val, idx)=>idx/selected_channels.length)
		for (var c in selected_channels) {
			var c1 = Number(c)+1;
			// data
			var C = selected_channels[c];
			var y = C.get_physical_samples(t0, window_duration);
			var dt = 1/C.sampling_rate();
			var x = Float32Array.from(new Array(y.length), (val, idx)=>idx*dt)
			var data = {
				x: x, y: y,
				mode: 'lines',
				line: { color: 'rgb(0.0, 0.0, 0.0)', width: 1.0 },
				yaxis: 'y'+c1
			};
			// layout
			layout['xaxis'+c1] = { anchor: 'y'+c1 };
			layout['yaxis'+c1] = {
				domain: [domain[c], domain[c1]],
				title: C.label
			};
			traces.push(data);
		}
		Plotly.newPlot("drawingArea", traces, layout);
	}

	function set_time(t0=0.0) {
		drawingArea = document.getElementById("drawingArea");
    selected_channels = get_selected_channels(selected.channels);
		for (var c in selected_channels) {
			var C = selected_channels[c];
			var y = C.get_physical_samples(t0, window_duration);
			var x = Float32Array.from(new Array(y.length), (val, idx)=>idx/C.sampling_rate())
			Plotly.restyle(drawingArea, {'x': x, 'y': y}, c);
		}
	}

	function files_loaded(evt) {
		select_file();
	}

	function setup(evt) {
		var fileSelector = document.getElementById('fileSelector');
		fileSelector.addEventListener("onchange", load_selected_file);
		load_selected_file();
	}
</script>
</head>
<body onload="setup()">

<div class="container">

<header>
	<h1>EDF Data Viewer (BETA Version)</h1>
	<hr>
  <div style="text-align:right">
    <label for="fileSelector">Choose file to analyze</label>
    <input type="file" id="fileSelector" onchange="load_selected_file();" accept=".edf"/>
  </div>
</header>

<div id="nav"></div>

<article>
<div class="areaFrame" id="areaFrame">
</div>
</article>

<footer>Powered by<a href="https://plot.ly">plotly</a><br>
	Copyright &copy; <a href="https://github.com/jusjusjus">jusjusjus</a></footer>

</div>

</body>
</html>

