<!DOCTYPE html>
<html>
<head>
<link rel="stylesheet" type='text/css' href="../css/edfbase.css"></style>
<link rel="stylesheet" type='text/css' href="../css/edfdataviewer.css"></style>
<!-- Load scripts locally -->
<script src="../js/plotly-latest.min.js"></script>
<script src="../js/edf.js"></script>
<script src="../js/plotting_area.js"></script>
<!-- Load scripts from CDNs -->
<script type="text/javascript">
  if (typeof EDF == 'undefined') {
    document.write(unescape("%3Cscript src='https://cdn.rawgit.com/jusjusjus/edfjs/master/js/edf.js' type='text/javascript'%3E%3C/script%3E"));
  }
  if (typeof Plotly == 'undefined') {
    document.write(unescape("%3Cscript src='https://cdn.plot.ly/plotly&#45;latest.min.js' type='text/javascript'%3E%3C/script%3E"));
  }
</script>
<script>
	var figure = null;

	async function load_selected_file () {
		var files = document.getElementById('fileSelector').files;
    var edf = EDF();
    await edf.from_file(files[0], files_loaded, header_only=false);
		figure = PlottingArea("figure", edf);
	}

	function files_loaded (evt=null) {
		refresh_navbar();
		figure.create_new_plot();
		create_slider();
	}

	function clear_filecache () {
    figure.del();
		delete figure;
		figure = null;
		document.getElementById("slider").innerHTML = "";
		refresh_navbar();
	}

	function refresh_navbar() {
    var nav = document.getElementById("nav");
    var txt = "";
    if (figure != null) {
			var channels = figure.channels();
      for (var c in figure.channels()) {
        var C = channels[c];
        txt += "<li";
        if (C.selected) {
          txt += " class='selected'";
        } else {
          txt += " class='unselected'";
        }
        txt += " onclick='figure.switch_selection("+c+", refresh_navbar)'>"+C.label+"</li>";
      }
      txt += "<li class='clear' onclick='clear_filecache()'>Clear</li>";
    }
    nav.innerHTML = txt;
	}

	function create_slider() {
		slider = document.getElementById("slider");
		var txt = "";
		txt += "<form class='sliderFrame' oninput='timeDisplay.value=figure.rel_date_str(1000*currTime.value)'>";
		txt += "<input class='timeSlider' type='range' id='currTime' name='currTime' min='0' max='"+figure.file.duration+"' value='0' oninput='figure.set_time(this.value)'>";
		txt += "<output id='timeDisplay' name='timeDisplay' for='currTime'></output></form>";
		slider.innerHTML = txt;
		requestAnimationFrame(function () {
			timeDisplay = document.getElementById("timeDisplay");
			timeDisplay.value = figure.rel_date_str(1000*currTime.value);
		});
	}

	function setup(evt) {
		var fileSelector = document.getElementById('fileSelector');
		fileSelector.addEventListener("onchange", load_selected_file);
		load_selected_file();
	}

</script>
</head>
<body onload="setup()">

<div class="container">

<header>
	<h3>EDF Data Viewer (BETA Version)</h3>
	<hr>
  <div style="text-align:right">
    <label for="fileSelector">Choose file to analyze</label>
    <input type="file" id="fileSelector" onchange="load_selected_file();" accept=".edf"/>
  </div>
</header>

<div id="nav"></div>

<article>
<div class="figure" id="figure"></div>
<div id="slider"></div>
</article>

<footer>Powered by <a href="https://plot.ly">plotly</a><br>
	Copyright &copy; <a href="https://github.com/jusjusjus">jusjusjus</a></footer>

</div>

</body>
</html>

