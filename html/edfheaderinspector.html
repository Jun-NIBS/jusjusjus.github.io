<!DOCTYPE html>
<html>
<head>
<link rel="stylesheet" type='text/css' href="../css/edfheaderinspector.css"></style>
<script src="https://cdn.rawgit.com/jusjusjus/edfjs/master/js/edf.js"></script>
<script>
	var opened_files = [];
	var edf = EDF();
	var selected = null;

	var load_selected_file = function () {
		var files = document.getElementById('fileSelector').files;
		for (var f=0; f<files.length; f++) {
			var edf = EDF();
			edf.from_file(files[f], files_loaded, header_only=true);
			opened_files.push(edf);
		}
	}

	var select_file = function (f) {
		selected = opened_files[f];
		refresh_navbar();
		refresh_edfinfo();
	}

	function refresh_navbar() {
		nav = document.getElementById("nav");
		var txt = "";
		for (var e in opened_files) {
			f = opened_files[e];
			txt += "<li "
			if (f === selected) {
				txt += "class='selected'"
			} else {
				txt += "onclick='select_file("+e+")'";
			}
			txt += ">"+f.filename+"</li>";
		}
		nav.innerHTML = txt;
	}

	var name_map = {
		'label': 'Label',
		'channel_type': 'Type',
		'physical_dimension': 'Unit',
		'physical_minimum': 'Min. Value',
		'physical_maximum': 'Max. Value',
		'digital_minimum': 'Digi. Min.',
		'digital_maximum': 'Digi. Max.',
		'prefiltering': 'Filter',
		'num_samples_per_record': 'Samples per Record',
		'reserved': 'reserved',
		'startdate': 'Date',
		'starttime': 'Time',
		'num_header_bytes': 'Size',
		'num_records': 'Records',
		'num_channels': 'Channels',
		'version': 'EDF Version',
		'pid': 'Patient ID',
		'record_duration': 'Sec. per Rec.',
		'rid': 'Record ID'
	};

	function refresh_edfinfo() {
		// Header
		var title = document.getElementById("filetitle");
		title.innerHTML = "<h3>Header and Channel Information for File '"+selected.filename+"'</h3>";
		var headerDiv = document.getElementById("header");
		var txt = "<table id='headerTab'>";
		txt += "<tr><th>Header field</th><th>Value</th></tr>";
		for (var key in selected.fields) {
			if(selected[key] === "") {
				val = 'empty';
			} else {
				val = selected[key];
			}
			if(key == "starttime") {
				val = val.replace(/\./g, ':');
			}
			txt += "<tr><td>"+name_map[key]+"</td><td>"+val+"</td></tr>";
		}
		txt += "</table>";
		headerDiv.innerHTML = txt;
		// Channels
		var channelsDiv = document.getElementById("channels");
		var channels = selected.channels;
		var txt = "<table id='channelsTab'>";
		txt += "<tr>";
		for (var key in channels[0].fields) {
			txt += "<th>"+name_map[key]+"</th>";
		}
		txt += "</tr>";
		for (var c in channels) {
			var channel = channels[c];
			txt += "<tr>";
			for (var key in channel.fields) {

				if(channel[key] === "") {
					val = 'empty';
				} else {
					val = channel[key];
				}
				txt += "<td>"+val+"</td>";
			}
			txt += "</tr>";
		}
		txt += "</table>";
		channelsDiv.innerHTML = txt;
	}

	function files_loaded(evt) {
		select_file(opened_files.length-1);
	}

	function setup(evt) {
		var fileSelector = document.getElementById('fileSelector');
		fileSelector.addEventListener("onchange", load_selected_file);
		load_selected_file();
	}
</script>
</head>
<body onload="setup()">

<div class="container">

<header>
	<h1>EDF Header Analyst</h1>
	<hr>
  <div style="text-align:right">
    <label for="file">Choose file to analyze</label>
    <input type="file" id="fileSelector" name="fileSelector" onchange="load_selected_file(this);" accept=".edf" multiple/>
  </div>
</header>

<div id="nav"></div>

<article>
<div class="edfinfo">
	<p id="filetitle">EDF Header Analyst</p>
	<div class="header" id="header">
		<h4>Introduction</h4>
		<p>EDF Header Analyst is a free tool allowing you to analyze your EDF-file header.</p>
	</div>
	<div class="channels" id="channels">
		<h4>Policy</h4>
		<p>The tool helps you protect sensitive patient information by showing you hidden fields in your EDF file.
		The tool is designed not to send any information back into the internet.  As proof, you may try to use
		this tool while completely disconnected from the internet.</p>
	</div>
</div>
</article>

<footer>Copyright &copy; jusjusjus</footer>

</div>

</body>
</html>

